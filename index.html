<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karsten Mana Calculator - MTG Deck Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(to bottom, #0f172a, #1e293b);
            min-height: 100vh;
            color: #e2e8f0;
        }
        .color-W { background-color: #F0E68C; color: #000; }
        .color-U { background-color: #0E68AB; }
        .color-B { background-color: #2d2d2d; }
        .color-R { background-color: #D3202A; }
        .color-G { background-color: #00733E; }
        .status-ok { border-left: 4px solid #10b981; }
        .status-low { border-left: 4px solid #f59e0b; }
        .status-critical { border-left: 4px solid #ef4444; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2">‚ö° Karsten Mana Calculator</h1>
            <p class="text-gray-400">MTG Mana Source Analyzer based on Frank Karsten's formula</p>
            <p class="text-sm text-gray-500 mt-1">
                <a href="https://www.channelfireball.com/article/frank-analysis-how-many-colored-mana-sources-do-you-need-to-consistently-cast-your-spells/8a1e" 
                   target="_blank" class="underline hover:text-blue-400">Original Article</a>
            </p>
        </div>

        <!-- Input Section -->
        <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-xl">
            <h2 class="text-xl font-bold mb-4">Decklist Input</h2>
            
            <!-- Deck Size Selector -->
            <div class="mb-4">
                <label class="block mb-2 font-semibold">Deck Format:</label>
                <div class="flex gap-4">
                    <button onclick="setDeckSize(40)" id="btn-40" class="px-4 py-2 rounded bg-slate-700 hover:bg-slate-600">
                        Limited (40)
                    </button>
                    <button onclick="setDeckSize(60)" id="btn-60" class="px-4 py-2 rounded bg-blue-600">
                        Constructed (60)
                    </button>
                    <button onclick="setDeckSize(99)" id="btn-99" class="px-4 py-2 rounded bg-slate-700 hover:bg-slate-600">
                        Commander (99)
                    </button>
                </div>
            </div>

            <!-- Decklist Textarea -->
            <textarea id="decklist" rows="12" 
                class="w-full bg-slate-900 rounded p-4 font-mono text-sm border border-slate-700 focus:border-blue-500 focus:outline-none"
                placeholder="Paste your decklist here (one card per line)&#10;&#10;Examples:&#10;4 Lightning Bolt&#10;1x Thoughtseize&#10;20 Mountain&#10;4 Sacred Foundry"></textarea>

            <!-- Buttons -->
            <div class="flex gap-4 mt-4">
                <button onclick="analyzeDecklist()" 
                    class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded font-semibold">
                    Analyze Decklist
                </button>
                <button onclick="loadExample()" 
                    class="px-6 py-2 bg-slate-700 hover:bg-slate-600 rounded">
                    Load Example
                </button>
                <button onclick="clearAll()" 
                    class="px-6 py-2 bg-slate-700 hover:bg-slate-600 rounded">
                    Clear
                </button>
            </div>

            <!-- Loading -->
            <div id="loading" class="hidden mt-4 text-center">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                <p class="mt-2 text-gray-400">Analyzing with Scryfall API...</p>
            </div>

            <!-- Errors -->
            <div id="errors" class="hidden mt-4 bg-red-900 bg-opacity-30 border border-red-700 rounded p-4">
                <h3 class="font-bold mb-2">‚ö†Ô∏è Errors:</h3>
                <ul id="error-list" class="list-disc list-inside text-sm text-red-300"></ul>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results" class="hidden">
            <!-- Summary -->
            <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-xl">
                <h2 class="text-2xl font-bold mb-4">üìä Deck Summary</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-slate-900 rounded p-4">
                        <div class="text-2xl font-bold text-blue-400" id="total-cards">-</div>
                        <div class="text-sm text-gray-400">Total Cards</div>
                    </div>
                    <div class="bg-slate-900 rounded p-4">
                        <div class="text-2xl font-bold text-green-400" id="total-lands">-</div>
                        <div class="text-sm text-gray-400">Lands</div>
                    </div>
                    <div class="bg-slate-900 rounded p-4">
                        <div class="text-2xl font-bold text-purple-400" id="total-spells">-</div>
                        <div class="text-sm text-gray-400">Spells</div>
                    </div>
                    <div class="bg-slate-900 rounded p-4">
                        <div class="text-2xl font-bold text-yellow-400" id="colors-count">-</div>
                        <div class="text-sm text-gray-400">Colors</div>
                    </div>
                </div>
            </div>

            <!-- Color Recommendations -->
            <div class="bg-slate-800 rounded-lg p-6 shadow-xl">
                <h2 class="text-2xl font-bold mb-4">üé® Mana Source Recommendations</h2>
                <div id="recommendations" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <script>
        // Karsten Tables (based on Frank Karsten's article)
        const KARSTEN_TABLES = {
            40: { // Limited
                1: { single: 10, double: null, triple: null },
                2: { single: 9, double: 14, triple: null },
                3: { single: 8, double: 13, triple: 16 },
                4: { single: 7, double: 12, triple: 15 },
                5: { single: 7, double: 11, triple: 14 },
                6: { single: 6, double: 10, triple: 14 },
                7: { single: 6, double: 10, triple: 13 }
            },
            60: { // Constructed
                1: { single: 14, double: null, triple: null },
                2: { single: 13, double: 20, triple: null },
                3: { single: 12, double: 19, triple: 22 },
                4: { single: 11, double: 18, triple: 22 },
                5: { single: 10, double: 16, triple: 21 },
                6: { single: 9, double: 15, triple: 20 },
                7: { single: 9, double: 14, triple: 19 }
            },
            99: { // Commander
                1: { single: 23, double: null, triple: null },
                2: { single: 21, double: 33, triple: null },
                3: { single: 20, double: 31, triple: 37 },
                4: { single: 18, double: 29, triple: 36 },
                5: { single: 17, double: 27, triple: 34 },
                6: { single: 16, double: 26, triple: 33 },
                7: { single: 15, double: 24, triple: 32 }
            }
        };

        let deckSize = 60;
        let analysisResults = null;

        function setDeckSize(size) {
            deckSize = size;
            ['40', '60', '99'].forEach(s => {
                const btn = document.getElementById(`btn-${s}`);
                btn.className = s == size 
                    ? 'px-4 py-2 rounded bg-blue-600'
                    : 'px-4 py-2 rounded bg-slate-700 hover:bg-slate-600';
            });
        }

        function loadExample() {
            const example = `// Mono Red Aggro Example
4 Lightning Bolt
4 Goblin Guide
4 Monastery Swiftspear
3 Eidolon of the Great Revel
2 Bonecrusher Giant
4 Light Up the Stage
2 Skullcrack
20 Mountain
4 Den of the Bugbear`;
            document.getElementById('decklist').value = example;
        }

        function clearAll() {
            document.getElementById('decklist').value = '';
            document.getElementById('results').classList.add('hidden');
            document.getElementById('errors').classList.add('hidden');
        }

        // Parse decklist
        function parseDecklist(text) {
            const lines = text.split('\n');
            const cards = [];
            
            for (const line of lines) {
                const trimmed = line.trim();
                // Skip empty lines and comments
                if (!trimmed || trimmed.startsWith('//') || trimmed.startsWith('#')) continue;
                
                // Match patterns like "4 Card Name" or "1x Card Name"
                const match = trimmed.match(/^(\d+)x?\s+(.+)$/i);
                if (match) {
                    const quantity = parseInt(match[1]);
                    const name = match[2].trim();
                    cards.push({ quantity, name });
                }
            }
            
            return cards;
        }

        // Fetch card data from Scryfall
        async function fetchCardData(cardName) {
            try {
                const response = await fetch(`https://api.scryfall.com/cards/named?fuzzy=${encodeURIComponent(cardName)}`);
                if (!response.ok) return null;
                const data = await response.json();
                return {
                    name: data.name,
                    mana_cost: data.mana_cost || '',
                    cmc: data.cmc || 0,
                    type_line: data.type_line || ''
                };
            } catch (e) {
                return null;
            }
        }

        // Parse mana cost
        function parseManaCost(manaCost) {
            const colors = { W: 0, U: 0, B: 0, R: 0, G: 0 };
            const matches = manaCost.match(/\{([WUBRG])\}/g) || [];
            matches.forEach(m => {
                const color = m.charAt(1);
                colors[color]++;
            });
            return colors;
        }

        // Analyze decklist
        async function analyzeDecklist() {
            const text = document.getElementById('decklist').value;
            if (!text.trim()) {
                alert('Please enter a decklist');
                return;
            }

            // Show loading
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');
            document.getElementById('errors').classList.add('hidden');

            const cards = parseDecklist(text);
            const errors = [];
            const colorRequirements = {};
            let totalCards = 0;
            let totalLands = 0;
            let totalSpells = 0;
            const manaSourcesByColor = { W: 0, U: 0, B: 0, R: 0, G: 0 };

            // Fetch card data
            for (const card of cards) {
                totalCards += card.quantity;

                const data = await fetchCardData(card.name);
                if (!data) {
                    errors.push(`Could not find: ${card.name}`);
                    continue;
                }

                const isLand = data.type_line.toLowerCase().includes('land');
                
                if (isLand) {
                    totalLands += card.quantity;
                    // Simple land type detection
                    const nameLower = data.name.toLowerCase();
                    if (nameLower.includes('plains') || nameLower.includes('—Å–∫–∞–π')) manaSourcesByColor.W += card.quantity;
                    if (nameLower.includes('island') || nameLower.includes('–æ—Å—Ç—Ä–æ–≤')) manaSourcesByColor.U += card.quantity;
                    if (nameLower.includes('swamp') || nameLower.includes('–±–æ–ª–æ—Ç–æ')) manaSourcesByColor.B += card.quantity;
                    if (nameLower.includes('mountain') || nameLower.includes('–≥–æ—Ä–∞')) manaSourcesByColor.R += card.quantity;
                    if (nameLower.includes('forest') || nameLower.includes('–ª–µ—Å')) manaSourcesByColor.G += card.quantity;
                    
                    // Dual lands (approximate)
                    const typeLineLower = data.type_line.toLowerCase();
                    if (typeLineLower.includes('plains') && typeLineLower.includes('forest')) {
                        manaSourcesByColor.W += card.quantity;
                        manaSourcesByColor.G += card.quantity;
                    }
                    // Add more dual land detection as needed
                } else {
                    totalSpells += card.quantity;
                    const colors = parseManaCost(data.mana_cost);
                    const turn = Math.max(1, Math.min(7, data.cmc || 1));
                    
                    for (const [color, count] of Object.entries(colors)) {
                        if (count > 0) {
                            const key = `${color}-${turn}-${count}`;
                            if (!colorRequirements[key]) {
                                colorRequirements[key] = { color, turn, pips: count, cards: [] };
                            }
                            colorRequirements[key].cards.push(data.name);
                        }
                    }
                }
            }

            // Hide loading
            document.getElementById('loading').classList.add('hidden');

            // Show errors if any
            if (errors.length > 0) {
                const errorDiv = document.getElementById('errors');
                const errorList = document.getElementById('error-list');
                errorList.innerHTML = errors.map(e => `<li>${e}</li>`).join('');
                errorDiv.classList.remove('hidden');
            }

            // Display results
            displayResults(totalCards, totalLands, totalSpells, colorRequirements, manaSourcesByColor);
        }

        function displayResults(totalCards, totalLands, totalSpells, colorRequirements, manaSourcesByColor) {
            // Update summary
            document.getElementById('total-cards').textContent = totalCards;
            document.getElementById('total-lands').textContent = totalLands;
            document.getElementById('total-spells').textContent = totalSpells;
            
            const activeColors = Object.values(manaSourcesByColor).filter(v => v > 0).length;
            document.getElementById('colors-count').textContent = activeColors;

            // Build recommendations
            const recommendationsDiv = document.getElementById('recommendations');
            recommendationsDiv.innerHTML = '';

            const colorNames = { W: 'White', U: 'Blue', B: 'Black', R: 'Red', G: 'Green' };
            const processedColors = new Set();

            for (const req of Object.values(colorRequirements)) {
                const { color, turn, pips } = req;
                
                if (processedColors.has(color)) continue;
                processedColors.add(color);

                // Find maximum requirement for this color
                const sameColorReqs = Object.values(colorRequirements).filter(r => r.color === color);
                let maxRequired = 0;
                let requirementText = '';

                for (const r of sameColorReqs) {
                    const table = KARSTEN_TABLES[deckSize][r.turn];
                    let needed = 0;
                    if (r.pips === 1) needed = table.single;
                    else if (r.pips === 2) needed = table.double;
                    else if (r.pips >= 3) needed = table.triple;
                    
                    if (needed > maxRequired) {
                        maxRequired = needed;
                        requirementText = `T${r.turn} ${r.pips === 1 ? '' : r.pips === 2 ? 'double' : 'triple'} (${r.cards[0]})`;
                    }
                }

                const current = manaSourcesByColor[color];
                const diff = current - maxRequired;
                let status = 'ok';
                if (diff < -2) status = 'critical';
                else if (diff < 0) status = 'low';

                const html = `
                    <div class="bg-slate-900 rounded p-4 status-${status}">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-3">
                                <span class="color-${color} px-3 py-1 rounded font-bold text-lg">${color}</span>
                                <span class="text-lg font-semibold">${colorNames[color]}</span>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold ${status === 'critical' ? 'text-red-400' : status === 'low' ? 'text-yellow-400' : 'text-green-400'}">
                                    ${current} / ${maxRequired}
                                </div>
                                <div class="text-sm text-gray-400">Current / Recommended</div>
                            </div>
                        </div>
                        <div class="text-sm text-gray-400 mt-2">
                            ${requirementText}
                        </div>
                        ${status === 'critical' ? '<div class="mt-2 text-red-400 text-sm">‚ö†Ô∏è Critically low! Add ' + Math.abs(diff) + ' more sources</div>' : ''}
                        ${status === 'low' ? '<div class="mt-2 text-yellow-400 text-sm">‚ö†Ô∏è Consider adding ' + Math.abs(diff) + ' more sources</div>' : ''}
                        ${status === 'ok' ? '<div class="mt-2 text-green-400 text-sm">‚úì Sufficient sources</div>' : ''}
                    </div>
                `;
                recommendationsDiv.innerHTML += html;
            }

            document.getElementById('results').classList.remove('hidden');
        }

        // Initialize
        setDeckSize(60);
    </script>
</body>
</html>